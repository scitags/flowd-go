# Building RPMs
Now, one would normally think building RPMs is quite a simple task right? The hard part
is bound to be writing the program itself, so walking the last mile should be in no way
a comparable hurdle. Enter [Koji][koji].

The contents of this file assume some familiarity with the RPM building process. The
bare minimum is knowing that:

- SRPMs include the source files needed to generate an RPM. You can think of it as a
  fancier `*.tar.gz`. The SRPM includes documentation and other auxiliary files such
  as SystemD units and the like.
- RPMs on the other hand contain the files that'll be deployed on the system where it's
  installed. When working with compiled languages, this would be the output of the
  compilation for instance.

So, with that in mind, from an SRPM we can generate different RPMs targeting several
architectures for example. Anyway, be sure to take a look at the [RPM Packaging Guide][rpm-guide]
and the harder to read [RPM Manual][rpm-manual] for (way more) information.

## Making a release
Just a quick TODO list for when we (inevitably) forget how to make a release:

1. Update the SPEC file (i.e. [`flowd-go.spec`](../flowd-go.spec)):
    1. Bump up the version to whatever it needs to be.
    1. Update any dependencies that need, well, updating.
    1. Add an entry to the **changelog** at the very end of the file.

1. Add the necessary tag to the `git(1)` repo itself.

1. Push the changes and tags to the remote.

1. Manually trigger the build from `lxplus` with

        $ koji build scitags9al "git+https://github.com/scitags/flowd-go.git#main"

1. Tag the package for both the [scitags9al-qa][] and [scitags9al-stable][] repos with
   (version numbers will differ)

        $ koji tag-build scitags9al-qa flowd-go-2.2.0-1
        $ koji tag-build scitags9al-stable flowd-go-2.2.0-1

1. Look for the result in the [scitags9al-testing][], [scitags9al-qa][] and
   [scitags9al-stable][] RPM repositories.

Should the build fail, one can re-run it with the `--scratch` option, thus avoiding
the extra tagging step:

    $ koji build --scratch scitags9al "git+https://github.com/scitags/flowd-go.git#main"

## Koji 101
Koji is a system aimed at making the process of releasing RPMs that much easier. Under the
hood it leverages [Mock][mock] which in turn makes use of `rpmbuild(1)` to build the RPMs.

What Koji brings to the table is a way of structuring the build process so that it's manageable,
especially when handling multiple architectures. The main concepts behind Koji are:

- **Package**: an 'umbrella' term that can get a bit more specific:
    - **Package**: a (somewhat) readable name for a given SRPM (i.e. `flowd-go`).
    - **Build**: a given build of a package (i.e. `flowd-go-2.1.0`).
    - **RPM**: a given RPM specifying architecture (i.e. `flowd-go-2.1.0-1.x86_64`).
- **Tags**: a collection of packages.
- **(Build) Target**: the 'glue' specifying where (i.e. which buildroot) a package should be built
  and how it should be tagged afterwards.

Now, building a package simply requires one to specify the build target like so:

    $ koji build scitags9al <srpm-or-git-url>

The second argument can be either the path to a local SRPM (i.e. `/path/to/my.srpm`) or the
URL of a project in a version control system such as `git(1)`. For our particular use case
the command to invoke would be

    $ koji build scitags9al "git+https://github.com/scitags/flowd-go.git#main"

where you can specify a REF after the `#` sign. Please note how this must be executed
from `lxplus` as CENR's Koji provides no outbound access!

Running the build will trigger the following process:

1. Generate a SRPM from the raw repository:
    1. We'll use `go mod vendor` to download all the code dependencies.
    1. This process **must** be kickstarted by running the `sources` target. This is a Koji-imposed constraint.
    1. The SRPM itself is generated by invoking the `srpm` target.
1. This SRPM is then leveraged to build the RPMs:
    1. Bear in mind there is no outbound connectivity in this step, hence the use of `go mod vendor`.
    1. The SRPM will be built for as many architectures as determined by the associated tag.
        - For us that's `x86_64` and `aarch64` at the moment.
    1. This process is handled by `mock(1)` behind the scenes.

If all goes well the packages will be built and you'll see them appear on the associated
repository over at

    https://linuxsoft.cern.ch/repos/scitags9al-testing/x86_64/os/Packages/f/
    https://linuxsoft.cern.ch/repos/scitags9al-testing/aarch64/os/Packages/f/

for the different target architectures. One can install the packages manually from here
to test them out with

    $ dnf install https://linuxsoft.cern.ch/repos/scitags9al-testing/x86_64/os/Packages/f/flowd-go-2.1.0-1.x86_64.rpm

or whatever version's the latest. Note how, by default once a package is successfully built it'll be added
to the `scitags9al-testing` tag and so it'll only appear on the `scitags9al-testing` repo over at:

    https://linuxsoft.cern.ch/repos/scitags9al-testing/x86_64/os

We need to **manually** tag the built package so that it finds its way into both `scitag9al-qa` and
`scitags9al-stable`. All it takes is running the following Koji commands:

    $ koji tag-build scitags9al-qa flowd-go-2.2.0-1
    $ koji tag-build scitags9al-stable flowd-go-2.2.0-1

Note how the version number will differ for each release. In order for the above to work, the packages
must've been added to the respective tags beforehand. This is something that needs to be done only
once (and it's already been done for `flowd-go`):

    $ koji add-pkg --owner=$(id -nu) scitags9al-qa flowd-go
    $ koji add-pkg --owner=$(id -nu) scitags9al-stable flowd-go

All in all, the usual way to install this packages is through the respective repositories, something
that can be easily configured with a `*.repo` file placed in `/etc/yum.repos.d` resembling:

```ini
[scitags-stable]
name     = Scitags Repository - stable
baseurl  = https://linuxsoft.cern.ch/repos/scitags9al-stable/$basearch/os
protect  = 1
enabled  = 1
gpgcheck = 1
gpgkey   = https://linuxsoft.cern.ch/repos/RPM-GPG-KEY-kojiv2

[scitags-qa]
name     = Scitags Repository - qa
baseurl  = https://linuxsoft.cern.ch/repos/scitags9al-qa/$basearch/os
protect  = 1
enabled  = 0
gpgcheck = 1
gpgkey   = https://linuxsoft.cern.ch/repos/RPM-GPG-KEY-kojiv2

[scitags-testing]
name     = Scitags Repository - testing
baseurl  = https://linuxsoft.cern.ch/repos/scitags9al-testing/$basearch/os
protect  = 1
enabled  = 0
gpgcheck = 1
gpgkey   = https://linuxsoft.cern.ch/repos/RPM-GPG-KEY-kojiv2
```

### A deeper look into Koji and co.
One can tell from the above that the integration with Koji is rather strong and at times brittle. The core
of the integration lives in the form of a Makefile living in `rpm.mk` in this same directory. Its
contents are derived mainly from the [example offered by CERN's IT Department][cern-myrpm]. We have retained
the possibility of building the RPMs locally through the `rpm` target though.

When looking into all this machinery one should never loose sight of how the key idea is that at some
point `rpmbuild(1)` will be invoked. `Mock(1)`'s purpose is isolating the packages buildroot from the
overall system whilst Koji's is orchestrating all the grunt work behind setting up `mock(1)`. One can
leverage `mock(1)` locally (after installing it) through the `rpm-mock` target in `rpm.mk`.

#### Build dependencies
Flowd-go has several buildtime dependencies, the main ones being `libbpf` and `go`. Now, when building
with `mock(1)` these dependencies are pulled in when building the RPM (not the SRPM) and must be
specified as a list of regular RPMs that'll get installed as part of the process. This of course means
that we can only depend on stuff available from CERN's Almalinux 9 repositories, period. What's more,
as we do not have access to Alma's [Vault][repo-vault] we can only depend on new-(ish) software
versions.

Even though it might go unnoticed, the repo we can pull dependencies from is **not** the stock one,
but rather CERN's available at

    http://linuxsoft.cern.ch/cern/alma/9

This repository trails behind AlmaLinux's one a bit, so you've been warned! For a list of available
CERN repos be sure to check

    https://linuxsoft.cern.ch/repos/

### Getting information out of Koji
In no particular order, the following commands have proved themselves useful in setting up all
this Koji bonanza:

    # Checking stuff works
    $ koji moshimoshi

    # Listing overall permissions
    $ koji list-permissions --mine

    # Listing information on targets
    $ koji list-targets | grep scitags

    # Listing information on builds
    $ koji list-builds --owner $(id -nu)

    # Listing information about tags
    $ koji list-tags scitags*
    $ koji list-tagged scitags9al-testing
    $ koji taginfo scitags9al-{testing,qa,build,stable}

    # Getting a mock configuration to mimic the process elsewhere
    $ koji mock-config --target scitags9al --arch x86_64
    $ koji mock-config --target scitags9al --arch aarch64

    # Getting information on built packages
    $ koji buildinfo flowd-go-2.1.0-1

    # Getting information on running (and finished) tags
    $ koji taskinfo <task-id>
    $ koji list-tasks --mine

    # Untagging builds so that we can cleanly re-run stuff
    $ koji untag-build scitags9al-testing flowd-go-2.1.0-1

    # Add a package to a tag (which must be done once)
    $ koji add-pkg --owner=$(id -nu) scitags9al-qa flowd-go
    $ koji add-pkg --owner=$(id -nu) scitags9al-stable flowd-go

    # Tag a package in *-testing so that it belongs to *-qa and *-stable too
    $ koji tag-build scitags9al-qa flowd-go-2.2.0-1
    $ koji tag-build scitags9al-stable flowd-go-2.2.0-1

<!-- REFs -->
[koji]: https://koji.build
[mock]: https://rpm-software-management.github.io/mock/
[koji-concepts]: https://docs.pagure.org/koji/using_the_koji_build_system/#koji-tags-and-packages-organization
[rpm-guide]: https://rpm-packaging-guide.github.io
[rpm-manual]: https://rpm-software-management.github.io/rpm/manual/
[cern-myrpm]: https://gitlab.cern.ch/linuxsupport/myrpm
[repo-vault]: https://vault.almalinux.org
[scitags9al-testing]: https://linuxsoft.cern.ch/repos/scitags9al-testing
[scitags9al-qa]: https://linuxsoft.cern.ch/repos/scitags9al-qa
[scitags9al-stable]: https://linuxsoft.cern.ch/repos/scitags9al-stable
